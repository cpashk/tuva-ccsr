version: 2

models:

### Intermediate

  - name: ccsr__dx_vertical_pivot
    config:
      materialized: table
    desription: This is an intermediate model that pivots the DXCCSR's wide-format mapping CSV
      into a long format table. While the seed uses 6 columns to represent the 6 CCSR codes that
      may be present, this generates one row for each CCSR category per ICD code, so up to
      6 rows per code. 
  - name: ccsr__procedure_category_map
    config:
      materialized: table
    description: This is an intermediate model that renames some PRCCSR columns to align with other TUVA
      models as well as the `ccsr__dx_vertical_pivot` model.
  
### Final

  - name: ccsr__long_condition_category
    config:
      materialized: table
    description: This model contains a mapping of individual condition ICD-10-CM diagnosis codes to the
      CCSR's clinically meaningful diagnosis categories. Each row represents a mapping of an ICD-10 code
      to a CCSR category. As each ICD-10 code may be mapped to up to 6 categories, it's expected
      that this table will output as many or more rows than the TUVA condition model.
      The model is equivalent to the CCSR's Output Option 1 - Vertical File Output.
    columns:
      - name: encounter_id
        tests:
          - not_null:
              config:
                severity: warn
      - name: claim_id
        tests:
          - not_null:
              config:
                severity: warn

  - name: ccsr__wide_condition_category
    description: |  
      This model contains a row for each input record with a column for every CCSR condition category. 
      Each column contains a value of 0, 1, 2, or 3. These values indicate:
        * 0 \- The CCSR was not triggered by any ICD-10-CM diagnosis code on the input record.
        * 1 \- The CCSR was triggered by only the principal (or first-listed) diagnosis on the input record.
        * 2 \- The CCSR was triggered by both the principal (or first-listed) diagnosis and any secondary diagnosis on the input record.
        * 3 \- The CCSR was triggered by only secondary diagnosis code(s) on the input record.
    config:
      materialized: table
    columns:
      - name: encounter_id
        tests:
          - unique
          - not_null:
              config:
                severity: warn

  - name: ccsr__singular_condition_category
    config:
        materialized: table
    description: This model contains only the CCSR's default category assignment for the ICD-10 code,
      and only for the first-listed ICD-10 code.
    columns:
      - name: encounter_id
        tests:
          - not_null:
              config:
                severity: warn
          - unique:
              config:
                severity: warn

      - name: claim_id
        tests:
          - not_null
          - unique:
              config:
                severity: warn

  - name: ccsr__long_procedure_category
    description: This model contains a mapping of individual condition ICD-10-PCS procedure codes to the
      CCSR's clinically meaningful procedure categories. Each row represents a mapping of an ICD-10 code
      to a CCSR category. The model is equivalent to the CCSR's Output Option 1 - Vertical File Output.
    config:
        materialized: table
    columns:
      - name: encounter_id
        tests:
            - not_null
    
  - name: ccsr__wide_procedure_category
    config:
        materialized: table
    description: |  
      This model contains a row for each input record with a column for every CCSR procedure category. 
      Each column contains a value of 0 or 1. These values indicate:
        * 0 \- The CCSR was not triggered by any ICD-10-PCS code on the input record.
        * 1 \- The CCSR was triggered by a procedure on the input record.  
      
      While the CCSR maps to values 0-3, these values require a procedure rank, but no rank is
      included in the TUVA procedure model.
    columns:
      - name: encounter_id
        tests:
            - unique
            - not_null:
                config:
                  severity: warn